# auto_pulse_calibration
auto_pulse_calibration是探维科技TensorPro系列产品的自动化脉宽标定软件，在Windows10 64位环境(Python支持库numpy)下开发测试通过，此版本目前供公司内部测试。使用者可在本文件定义类的基础上继续编程。

# 软件功能介绍

本程序包括三个子程序：

1. com_test.py用于测试步进电机能否正常工作。包括确定步进电机在测试电脑上占据的COM端口号，以及在不与雷达通信的情况下进行双向移动等功能。

    - 查询端口号功能利用python自带的serial.tools.list_ports.comports()指令，将与测试电脑连接的所有COM口打印出来。只要在测试时保证只有步进电机一个设备连接至电脑即可，此时打印出的唯一端口号即为步进电机端口号。
    
    - 双向移动功能利用ModBus协议向步进电机发送相应指令实现。可以设置电机的运动方向，运动步长（由step参量控制）以及步数（由num参量控制）。电机运动过程将分步进行，每步运动相应步长后会短暂停止，直到走完所设定步长为止。步长参量以电机脉冲数为单位，系统默认设置挡位6400脉冲对应1厘米。如果设置步长参量step=640，步数参量num=10，则电机移动距离为640*10/6400=1厘米。目前提供的步长选项为0.5mm，1.5mm，2.5mm，3.5mm，4.5mm几种。

2. auto_measure_width.py用于驱动自动化测试工站进行标定数据采集。
    
    程序利用ModBus协议和步进电机进行通信，利用网口和雷达进行通信，可以实现驱动衰减片工装运动，采集雷达UDP包的功能。

    下边描述一下测量过程的程序逻辑：

    - 程序开始运行后，将首先驱动衰减片工装向前移动一个步长（程序设定步长为1mm）。待运动停止后，软件将采集1700个UDP包数据（20帧），其中水平角度为90°的各通道数据保存在以测试序号命名的txt文档中。

    - 当完成最后一次数据采集后(程序设置总步数为80)，程序将控制步进电机反向，并驱动衰减片工装反向运动，停止在开始测试的位置，方便进行下一次标定测试。

3. pulse_calibration_flash.py可利用auto_measure_width.py采集的原始数据生成脉宽修正查找表。该查找表可用于FPGA版本7.5.0及之后所有版本的机器，查找表下载到flash中，包含校验位功能。

    - 对于每个原始数据文件，程序将16个通道的所有有效测距值及脉宽值收集起来（测距值大于0小于10米，脉宽值大于0小于8米），滤除其中偏差大于三倍标准差的点后，计算剩余数据的平均值。这样对于每一个数据文件都会得到16个通道在此衰减率下的测距平均值及平均脉宽。

    - 在完成所有数据的统计后，利用上述数据绘制测距-脉宽变化曲线图及脉宽修正曲线图。测距-脉宽变化曲线图横坐标为测试序号，纵坐标为每个通道的实际测距值及脉宽值，均以米为单位。其中测距值以蓝色线表示，脉宽以红色线表示，共16张图，展示每一个通道的测距及脉宽随衰减率的变化。
    - 脉宽修正曲线图横坐标为每个通道的实测脉宽值序列，纵坐标为该脉宽下的距离修正值，均以米为单位。距离修正值为该脉宽下测距均值与该通道在整个脉宽范围内的最小测距均值之差。
   
    - 脉宽修正查找表的数据格式如下：每个通道包含256个数据，前2行数据表示查找表覆盖的脉宽范围，以count为单位。后面的253行表示对应的距离修正值，同样以count为单位。最后一行为校验位

        下边举例说明，当获得一个脉宽值，其对应的测距修正值的查找方法如下：
      - 该通道修正表第一行的数据为N0，第二行数据为Nm
      - 脉宽的count值除以8再向下取整后得N
      - 如果N小于N0，则令N=N0；如果N大于Nm，责令N=Nm
      - 对应的数据行数应为“N-N0+3”
    
# 软件下载

1. 下载代码

```bash
git clone https://github.com/tanwayRD/auto_pulse_calibration.git
```

输入用户名密码，下载成功后，所在git工作目录下就会出现程序包。此步骤也可直接在github的项目下直接下载程序的zip压缩包，然后解压到所需文件夹下。

# 软件使用

1. com_test.py的使用：利用pycharm打开程序并点击运行，会有弹窗出现

    - 获得com端口号：点击弹窗中的‘获取COM端口号’按钮，程序会在相应窗口中打印出步进电机使用的com号。

    - 双向移动：在点击‘获取COM端口号’按钮后，正确设置方向，步长、步数等参量，点击‘运动’按钮。程序会沿设定方向移动相应的距离。


2. auto_measure_width.py的使用

    - 开始测试前，利用com_test.py程序将衰减片工装移动到接近开始端起始位置（距离边缘约5mm即可）。保证在测试开始时遮挡收发口径的为衰减片的低反射率部分。位置确定后点击控制器上的复位按钮。
    - 将利用com_test.py程序得到的COM口信息以及想要保存原始数据的路径填入配置文件对应位置。端口号直接填入相应数字，数据保存路径请保证最后两级文件夹命名方式为pro_XXXX/pulse，其中XXXX代表雷达编号。
    - 利用pycharm打开程序并点击运行，将有弹窗出现。点击浏览按钮加载配置文件后，点击运行按钮，系统将自动完成测试，步进电机会回到起始位置。在数据保存路径下将得到一系列以测试序号命名的txt格式原始文件。程序运行结束后，pycharm窗口内会打印出Finish字样。
    

3. pulse_calibration_flash.py的使用

    - 确定配置文件中修正功能通道选通符合客户要求（0关闭，1开启，默认所有通道全部开启）。
    - 利用pycharm打开程序并点击运行，将有弹窗出现，正确加载原始数据路径及配置文件，点击运行即可。程序将自动完成数据处理，并在完成后于pycharm窗口内打印Finish字样
    - 程序将在数据路径下生成result文件夹，里面包含距离-脉宽变化曲线图，脉宽修正曲线图以及查找表文件。

